

@model Jig_system_control.Models.Jig


@{
    ViewBag.Title = "Jig Detail";
    Layout = "~/Views/Shared/_AfterLogin.cshtml";
}

<script src="~/js/jquery.min.js"></script>
<link href="~/css/select2.css" rel="stylesheet" />
<script src="~/js/select2.min.js"></script>



<div class="container-fluid">
    <div class="row justify-content-center">
 
            <div class="col-6 col-lg-4">
                <select name="searchForm" id="searchForm" class="form-control w-75 mx-auto"></select>
            </div>
  
    </div>

    @if (Model != null)
    {
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">

                <h3 class="mb-4">Thông tin Jig: <span class="text-primary">@Model.JigCode</span></h3>

                <ul class="nav nav-tabs" id="jigTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="info-tab" data-toggle="tab" href="#info" role="tab">Thông tin chung</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="doc-tab" data-toggle="tab" href="#doc" role="tab">Tài liệu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="draw-tab" data-toggle="tab" href="#draw" role="tab">Bản vẽ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="part-tab" data-toggle="tab" href="#part" role="tab">Linh kiện</a>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <!-- TAB THÔNG TIN CHUNG -->
                    <div class="tab-pane fade show active" id="info" role="tabpanel">
                        <div class="row">
                            <div class="col-md-4">
                                <img src="@Model.Image" class="img-thumbnail" style="width: 400px; height:400px" alt="Jig Image" />
                              
                            </div>
                            <div class="col-md-8">
                                <table class="table table-striped table-hover">
                                    <tr><th>Mã Jig</th><td>@Model.JigCode</td></tr>
                                    <tr><th>Tên Jig</th><td>@Model.JigName</td></tr>
                                    <tr><th>Model</th><td>@Model.Model</td></tr>
                                    <tr><th>Type</th><td>@Model.Type</td></tr>
                                    <tr><th>Range</th><td>@Model.Range</td></tr>
                                    <tr><th>Version</th><td>@Model.Version</td></tr>
                                    <tr><th>Ghi chú</th><td>@Model.Note</td></tr>
                                </table>
                                <button class="btn btn-warning" onclick="openEditInfoModal()">✏️ Sửa thông tin</button>
                            </div>
                        </div>
                    </div>

                    <!-- TAB TÀI LIỆU -->
                    <div class="tab-pane fade" id="doc" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>Tài liệu đính kèm</h5>
                            <button class="btn btn-primary" onclick="openAddDocModal()">+ Thêm tài liệu</button>
                        </div>

                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Loại tài liệu</th>
                                    <th>Tên file</th>
                                    <th>Phiên bản</th>
                                    <th>Ghi chú</th>
                                    <th style="width: 120px;"></th>
                                </tr>
                            </thead>
                            <tbody id="docTable">
                                @foreach (var doc in Model.JigDocument)
                                {
                                    <tr id="doc_@doc.DocID">
                                        <td>@doc.DocType</td>
                                        <td><a href="@doc.FilePath" target="_blank">@doc.FileName</a></td>
                                        <td>@doc.Version</td>
                                        <td>@doc.Note</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="editDoc(@doc.DocID)">Sửa</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteDoc(@doc.DocID)">Xóa</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- TAB BẢN VẼ -->
                    <div class="tab-pane fade" id="draw" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>Bản vẽ Jig</h5>
                            <button class="btn btn-primary" onclick="openAddDrawingModal()">+ Thêm bản vẽ</button>
                        </div>

                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Tên bản vẽ</th>
                                    <th>Tên File</th>
                                    <th>Phiên bản</th>
                                    <th>Ghi chú</th>
                                    <th style="width: 120px;"></th>
                                </tr>
                            </thead>
                            <tbody id="drawTable">
                                @foreach (var draw in Model.JigDrawing)
                                {
                                    <tr id="draw_@draw.DrawingID">
                                        <td> @draw.DrawingName</td>
                                        <td><a href="@draw.FilePath" target="_blank">@draw.FileName</a></td>
                                        <td>@draw.Version</td>
                                        <td>@draw.Note</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="editDrawing(@draw.DrawingID)">Sửa</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteDrawing(@draw.DrawingID)">Xóa</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- TAB LINH KIỆN -->
                    <div class="tab-pane fade" id="part" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>Danh sách linh kiện</h5>
                            <button class="btn btn-primary" onclick="openAddPartModal()">+ Thêm linh kiện</button>
                        </div>

                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Tên linh kiện</th>
                                    <th>Maker</th>
                                    <th>Số lượng</th>
                                    <th>Ghi chú</th>
                                    <th style="width: 120px;"></th>
                                </tr>
                            </thead>
                            <tbody id="partTable">
                                <p>Số linh kiện: @Model.JigPartList.Count()</p>

                                @foreach (var p in ViewBag.PartDisplay)
                                {
                                    <tr id="part_@p.PartID">
                                        <td>@p.Code</td>
                                        <td>@p.Name</td>
                                        <td>@p.Maker</td>
                                        <td>@p.Qty</td>
                                        <td>@p.Note</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="editPart(@p.PartID)">Sửa</button>
                                            <button class="btn btn-sm btn-danger" onclick="deletePart(@p.PartID)">Xóa</button>
                                        </td>
                                    </tr>
                                }


                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
    }
    </div>

<!-- MODAL CHUNG -->
<div class="modal fade" id="modalAction" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Nội dung form sẽ load động bằng AJAX -->
            </div>
        </div>
    </div>
</div>

<script>
    const jigId = @(Model != null ? Model.JigID : 0);

function openAddDocModal() {
    $("#modalTitle").text("Thêm tài liệu mới");
        $("#modalBody").load("/Home/AddDocumentPartial?jigId="+jigId, function () {
            $("#modalAction").modal("show");
        });
}

function openAddDrawingModal() {
    $("#modalTitle").text("Thêm bản vẽ mới");
    $("#modalBody").load("/Home/AddDrawingPartial?jigId="+jigId, function () {
        $("#modalAction").modal("show");
    });
}

function openAddPartModal() {
    $("#modalTitle").text("Thêm linh kiện mới");
    $("#modalBody").load("/Home/AddPartPartial?jigId="+jigId, function () {
        $("#modalAction").modal("show");
    });
}

function deleteDoc(id) {
    if (!confirm("Xóa tài liệu này?")) return;
    $.post("/Home/DeleteDocument", { id: id }, function (res) {
        if (res.success) $("#doc_" + id).fadeOut();
        else alert(res.message);
    });
}

function deleteDrawing(id) {
    if (!confirm("Xóa bản vẽ này?")) return;
    $.post("/Home/DeleteDrawing", { id: id }, function (res) {
        if (res.success) $("#draw_" + id).fadeOut();
        else alert(res.message);
    });
}

function deletePart(id) {
    if (!confirm("Xóa linh kiện này?")) return;
    $.post("/Home/DeletePart", { id: id }, function (res) {
        if (res.success) $("#part_" + id).fadeOut();
        else alert(res.message);
    });
}

function openEditInfoModal() {
    $("#modalTitle").text("Chỉnh sửa thông tin Jig");
    $("#modalBody").load("/Home/EditInfoPartial?jigId="+jigId, function () {
        $("#modalAction").modal("show");
    });
}
</script>

<script>

            // Khởi tạo select2 với ajax
            $('#searchForm').select2({
                theme: "bootstrap4",
                placeholder: "Tìm Jig theo Code hoặc Name...",
                minimumInputLength: 2,
                ajax: {
                    url: '/Home/GetSuggestions',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return { query: params.term };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(function (item) {
                                return {
                                    id: item.JigID,
                                    text: item.JigCode + ' - ' + item.JigName + ' (' + item.Model + ')'
                                };
                            })
                        };
                    },
                    cache: true
                }
            });

    $('#searchForm').on('select2:select', function (e) {
        const jigId = e.params.data.id;
        console.log('Selected JigID:', jigId); // debug
        if (jigId)
            window.location.href = '/Home/Detail/' + jigId;
        else
            alert('Không lấy được ID Jig!');
    });
</script>
